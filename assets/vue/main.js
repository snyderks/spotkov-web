Vue.component('spotify-login', {
  template: '<button class="btn login-btn" v-on:click="spotifyLogin">Login to Spotify</button>',
  replace: true,
  methods: {
    spotifyLogin: function () {
      $.ajax({
        url: 'http://localhost:8080/api/spotifyLoginUrl',
        type: 'GET',
        dataType: 'json'
      })
      .done(function(data) {
        console.log(data)
        if (data.URL !== undefined) {
          if (data.URL.match(/https:\/\/accounts.spotify.com\/authorize?/) != null) {
            window.location = data.URL
          }
        } else {
          fail()
        }

      })
      .fail(function(data) {
        console.log("error")
        console.log(data)
      })
    }
  }
})

var app = new Vue({
  el: '#app',
  data: {
    songs: [],
    songName: "",
    artistName: "",
    length: "20",
    error: "",
    activity: false
  },
  computed: {
    loggedIn: function () {
      return localStorage.getItem("access_token") !== null
    },
    songLabel: function () {
      return parseInt(this.length) === 1 ? "song" : "songs"
    },
    playlistGenerated: function () {
      return this.songs.length > 0
    }
  },
  methods: {
    getSongs: function () {
      activity = true
      error = ""
      var comp = this
      if (localStorage.getItem("access_token") !== null) {
        var token = {}
        token.access_token = localStorage.getItem("access_token")
        token.expiry = localStorage.getItem("expiry")
        token.refresh_token = localStorage.getItem("refresh_token")
        token.token_type = localStorage.getItem("token_type")

        var request = {}
        request.length = comp.length
        request.title = comp.songName
        request.artist = comp.artistName
        request.token = token
        request.lastFmUsername = "snyderks"
        request = JSON.stringify(request)
        $.ajax({
        url: 'http://localhost:8080/api/getPlaylist',
        type: 'POST',
        dataType: 'json',
        data: request
      })
      .done(function(data) {
        comp.songs = data
        console.log(data)
      })
      .fail(function(data) {
        console.log("error")
        console.log(data)
        comp.error = "The song and artist couldn't be used. Try again."
      })
      .always(function() {
        activity = false
      })
      }
    },
    createPlaylist: function () {
      /* TODO: Create a function to handle this. */
      var comp = this
      var token = {}
      token.access_token = localStorage.getItem("access_token")
      token.expiry = localStorage.getItem("expiry")
      token.refresh_token = localStorage.getItem("refresh_token")
      token.token_type = localStorage.getItem("token_type")

      var request = {}
      request.token = token
      request.playlistName = "Generated by Spotkov"
      request.songs = this.songs
      request = JSON.stringify(request)
      $.ajax({
        url: 'http://localhost:8080/api/createPlaylist',
        type: 'POST',
        data: request
      })
      .done(function () {
        comp.error = ""
        console.log("successfully posted to spotify")

      })
      .fail(function () {
        comp.error = "Couldn't connect to Spotify. Please try again later."
        console.log("failed to post to spotify")
      })
    }
  }
})
